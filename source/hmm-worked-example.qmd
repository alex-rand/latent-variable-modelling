# Regression With Latent Predictors

```{r}
#| label: setup
#| message: false
#| warning: false

# Load packages
library(tidyverse)
library(lavaan)
library(blavaan)
library(brms)
library(tidybayes)
library(survival)
library(survminer)

# Stan backend specifications
options(brms.backend = "cmdstanr")
options(mc.cores = parallel::detectCores())

# Borrow the Gustav Klimt pallate from MetBrewer https://github.com/BlakeRMills/MetBrewer/blob/main/R/PaletteCode.R
clrs <- list(pink = "#df9ed4", red = "#c93f55", yellow = "#eacc62", green = "#469d76", blue = "#3c4b99", purple = "#924099")

# Make a reusable ggplot theme, borrowing from Andrew Heiss: https://www.andrewheiss.com/blog/2022/05/20/marginalia/
theme_nice <- function() {
   theme_minimal(base_family = "Lato") +
   theme(panel.grid.major = element_blank(),
          plot.background = element_rect(fill = "white", color = NA),
          plot.title = element_text(face = "bold"),
          axis.title = element_text(face = "bold"),
          strip.text = element_text(face = "bold"),
          legend.title = element_text(face = "bold"))
}

# A function for density plots, of which we have many.
theme_posterior_densities <- function() {
  theme(axis.text.y = element_blank()) 
}

```

Working from [this IMF paper](https://www.imf.org/en/Publications/WP/Issues/2019/12/20/Labor-Market-Dynamics-A-Hidden-Markov-Approach-48798).

## The problem {.unnumbered}

Most labour market transition models assume:

1. All workers are the same. So like same transition probabilities for everyone at all times;
2. Transitions in labour force status **follow a first-order Markov process**. So like your transition probabilities only depend on your current status.

But these models fail to generate sequences that look like the data we actualy have. Here are a few pieces of simple background knowledge the model is ignoring:

1. A person's transition probabilities obviously depend on who that person is/what's going on in their life;
2. Perhaps most importantly, a person's transition probabilities obviously depend on their labour force history: _"Long-term unemployed workers have a significantly lower chance of holding a full-time job one year later than do their short-term counterparts. An unemployment spell begets future unemployment, and returning to employment does not fully reset the clock for unemployed workers... Most prominently, the
probability of finding a job declines with the duration of unemployment because of human capital depreciation, employer discrimination in the hiring process, and lower search effort due to discouragement."_

## The solution

Let's do a model that includes **a latent concept of 'time-varying labour market attachement'**. We can imagine that a person's latent 'labour market attachment' captures all the unobserved things that influence a person's timepoint-specific transition probabilities. Why do this?

1. **Heterogeneity between people.** We know empirically that even people with the same measured labour force status are not homogenous in their transition probabilities, and this 'latent variable' approach is one way of capturing this heterogeneity, and capturing it in a way that is consistent with our background knowledge [although still seems pretty parsimonious from a background-knowledge perspective imho].
2. **Duration dependence**. We know empiricaly that peoples' transition probabilities are dependent on their employment histories, i.e. how long they've been unemployed for. The latent variable approach will give us a way of capturing that [I'm not sure how yet].

## Other things people have tried

Some people did [a cool HMM model to corect for classification error](https://www.aeaweb.org/articles?id=10.1257/aer.103.2.1054), where people misreport their actually labour force status. I'd like to learn more about that. Apparently the present model nests that model -- we would just need to allow for exactly one latent state per possible emission. 

## The data

He uses the "full panel of the Current Population Survey". I think the LFS is the closest Canadian equivalent. 

## The model

He includes 3 possible emission states: 

1. Employed;
2. Unemployed;
3. Nonparticipating.

We'll want the model to be such that the probability of transition between each pair of these states is modelled using heterogeneity and duration dependence, not just the probability of transitioning out of unemployment, as some previous models have apparently done. This is smart because yeah maybe your most recent duration of unemployment predicts your probability of _losing_ your next job, not just your probability of _getting_ it in the first place. Same goes for transitioning to-and-from nonparticipation. 

### Dumb 'canonical' model
He starts by discussing the basic 'canonical' model of labour force transitions that doesn't invoke latent states. Basically the 'canonical' thing is to just make a table of the cumulative empirical transitions (like basically a discrete cumulative incidence curve) relative to the first timepoint of the observed person, for everyone in each of the 3 possible emission states at their t=0. Actually, do this separately for each new cohort that enters the survey, then take the average across all cohorts. The 'canonical' model just uses these as your transition probabilities. But yeah obviously this assumes everyone is the same. We can present this in matrix notation where, in survival-analysis fashion, the 'hazard' of transitioning from one state to another just accumulates as you move thru time:

$$
\lambda_{y_t, y_{t+2}} = \sum_{y_{t+1}} \lambda_{y_t, y_{t+1}} \lambda_{y_{t+1}, y_{t+2}}
$$

And we can pack this into a lovely matrix over all the possible emission states, where E = employed, U = Unemployed, O = Out of the market.
$$
\begin{array}{ccc}
\lambda_{E_t, E_{t+\tau}} & \lambda_{E_t, U_{t+\tau}} & \lambda_{E_t, O_{t+\tau}} \\
\lambda_{U_t, E_{t+\tau}} & \lambda_{U_t, U_{t+\tau}} & \lambda_{U_t, O_{t+\tau}} \\
\lambda_{O_t, E_{t+\tau}} & \lambda_{O_t, U_{t+\tau}} & \lambda_{O_t, O_{t+\tau}}
\end{array}
$$

Apparently this model does a really bad job capturing what we see in the data, which makes a lot of sense to me because it is really dumb. At the very least we would want to model transition probabilities as a function of peoples' _observed_ demographic charachteristics. And also we would like to model them as a function of _unobserved_ characteristics like 'human capital' etc.

### Slightly better but still dumb model



