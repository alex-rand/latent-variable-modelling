---
title: "CFA"
format:
  html:
    theme: default
---

## Getting started

Let's load the packages we'll need for what is to come in this chapter:

```{r message=FALSE, results=FALSE}

library(tidyverse)
library(lavaan)

```

## Example 1: Toxic Striving Energy

The first example we'll look at is from @Finch2015. chapter 3. The practice dataset is introduced on page 10. It is from a study about human motivation. The dataset is a weird questionnaire called the 'Achievement Goal Scale' (AGS), which asks people 12 questions about how much toxic striving energy they have. The dataset provided seems to have lots of mysterious columns in it, but we're probably good to just keep the columns with responses to the AGS questionnaire:

```{r message=FALSE, warning=FALSE}

### Load the data
dat_raw <- foreign::read.spss('data/finch-and-french/edps744.sav') 
  
### Clean the data
dat_ags <- dat_raw %>% 

  # Convert to a data frame for ease of use
  as.data.frame() %>% 
  
  # Keep only columns that start with the prefix 'ags' followed by a question number
  select(matches("ags\\d")) 

```

### Data Exploration

We don't want to do too much exploration before fitting our factor models, because the whole game of CFA is to commit to our hypotheses before checking what the data looks like, so we don't mislead ourselves with [forking paths](http://www.stat.columbia.edu/~gelman/research/unpublished/p_hacking.pdf). But just for fun, we can explore the distributions of the answers to each of the 12 questions:

```{r warning = FALSE, message = FALSE}

dat_ags %>% 

  # Pivot to prepare the data for visualization
  pivot_longer(
    cols      = everything(),
    names_to  = "question",
    values_to = "response",
    names_transform = list(question = fct_inorder)  
  ) %>% 

  # Plot
  ggplot() +
  geom_histogram(aes(x = response)) + 
  theme_bw() + 
  facet_wrap(~question)

```

Seems like some questions have different means and variances from each other. For example, the answers to `ags11` and `ags12` are relatively flat, while the answers to `ags4` and `ags5` are more bunched up around the highest values. The responses clearly skew towards higher values in aggregate.

We can also do some healthy exploration of missingness in the dataset. For starters: what proportion of values are missing in each row?

```{r}

dat_ags %>% 
  
  # Calculate the proportion of missing values 
  summarise_all(~ sum(is.na(.)) / (sum(is.na(.) + sum(!is.na(.))))) %>% 
  
  # Rounding to make the results more presentable
  mutate(across(everything(), round, 6)) %>% 
  
  # Create the table
  knitr::kable(title = "Proportion of Missing Responses in Each Column") 

```

That's very little missingness. Probably no need to do multiple imputation here.

The authors also do a preliminary test of whether the responses are normally distributed, since this is one of the fundamental assumptions of maximum likelihood estimation. Kristoffer Magnusson has created [a cool interactive teaching tool that nicely illustrates this point](https://rpsychologist.com/likelihood/). It is worth remembering that we *do not* make this type of assumption for linear regression in general -- only for maximum likelihood estimates. All we need assume for linear regression is that the *residuals* are normally distributed, as opposed to the data themselves. This common misunderstanding leads to what Richard McElreath has called ['histomancy'](https://stats.stackexchange.com/questions/515444/histomancy-what-does-mcelreath-propose-we-do-instead).

To evaluate the assumption of normalness underlying maximum likelihood estimation, the authors do what seems to be a multivariate version of a classic 'normal probability plot'. These are explained nicely in [this stack exchange thread.](https://stats.stackexchange.com/questions/218638/understanding-normal-probability-plots) They also produce some of the classic tests of skew and kurtosis, which I don't want to get into here. [This youtuber](https://www.youtube.com/watch?v=TM033GCU-SY&t=26s) has nice introductory videos about these topics.

```{r}

# Run the Mardia tests for normalness
mardia.object <- psych::mardia(dat_ags)

# Plot the multivariate version of the normal probability plot
plot(mardia.object)

# Present the outputs we're interested in
tibble(
  "Skew" = mardia.object$skew,
  "Skew p-value" = mardia.object$p.skew,
  "Kurtosis" = mardia.object$kurtosis,
  "Kurtosis p-value" = mardia.object$p.kurt
) %>% 
  
  knitr::kable()
  

```

The plotted points don't seem to fit the straight line super well, which suggests that the normalness assumption may not hold here. Also, the hypothesis tests for skew and kurtosis return some mighty low p-values, suggesting that we've got lots of each of them. So maybe maximum likelihood estimation isn't such a good idea here?

The authors proceed with it anyway for pedogogical reasons, because they want to illustrate how the maximum likelihood estimates differ from estimates arrived at using other methods.

> In actual practice, given the lack of multivariate normality that seems apparent in the previous results, we would likely not use ML and instead rely on the alternative estimation approach.

### Model Fitting

The researchers who collected the data do what good factor analysts do: they look to the literature to set up some clear and specific candidate hypotheses, and see the degree to which this new data is compatible with each of them.

One of the candidate hypotheses is that a person's toxic striving energy ('achievement goal orientedness'?) is secretly driven by four platonic unobservable things, namely:

1.  Mastery Approach 'MAP' (eg. *"I want to learn as much as possible")*;

2.  Mastery Avoidant 'MAV' (eg. *"I want to avoid learning less than I possibly could"*);

3.  Performance Approach 'PAP' (eg. *"I want to do well compared to other students");*

4.  Performance Avoidant 'PAV' (eg. *"It is important for me to avoid doing poorly compared to other students"*)

We'll call the above hypothesis **H1.** But there's another hypothesis that says actually the 'Mastery' variables are just one monolithic thing, so really there are only 3 factors, namely 'Mastery', 'PAP', and 'PAV'. We'll call this one **H2.**

These will be the two candidate hypotheses we're gonna test via factor analysis.

The way **lavaan** works is that you need to separately define the model syntax as a string, and then feed that string to one of the model-fitting functions like `cfa()` . Then we can call the `summary()` function to get a big table of outputs.

```{r message=FALSE, warning=FALSE}

# Define the relationships from my hypothesis
h1.definition <- 
'map=~ags1+ags5+ags7
mav=~ags2+ags6+ags12
pap=~ags3+ags9+ags11
pav=~ags4+ags8+ags10'

# Fit the model
h1.fit <- cfa(
  data  = dat_ags,
  model = h1.definition
)

# Look at the results
summary(h1.fit, fit.measures = TRUE)

semPlot::semPaths(h1.fit)

```

That's a lot of outputs. Let's talk about what's here.

### Goodness of Fit Statistics

#### Chi-Squared Statistic

The main thing to look at is the chi-squared statistic from the 'User Model', IE the model I, the user, have just fit. I like to think of this as a measure of how different the model's reconstructed correlation matrix looks compared to the actual empirical correlation matrix of the data. So we use this statistic to test the null hypothesis "there is no significant difference between model's reconstructed correlation matrix and the empirical one". So, confusingly, we're actually hoping to *accept* the null hypothesis here. This model returns a value of 328.312 with a vanishingly small p-value, so we reject the null hypothesis, which is bad: it suggests our model isn't doing a good job replicating the empirical correlation matrix.

Here's a quote from @gorsuch1983 that explains this stuff from the slightly different angle:

> "The test of significance \[for a CFA model fit by maximum likelihood\] gives a chi-square statistic with the null hypothesis being that all the population covariance has been extracted by the hypothesized number of factors. If the chi-square is significant at the designated probability level, then the residual matrix still has significant covariance in it."

So this chi-squared statistic provides a first look at goodness-of-fit, but \@Finch2015 say it is actually not very trustworthy in practice because the null hypothesis is sort of crazy: we want a more permissive test than just whether the model is *perfectly* recreating the empirical correlation matrix.

> "this statistic is not particularly useful in practice because it tests the null hypothesis that \[the model-reconstructed correlation matrix is equal to the empirical correlation matrix\], which is very restrictive. The test will almost certainly be rejected when the sample size is sufficiently large... In addition, the chi-square test relies on the assumption of multivariate normality of the indicators, which may not be tenable in many situations."

So we're gonna wanna look at statistics other than just chi-squared for goodness-of-fit.

#### Root Mean Squared Error Approximation (RMSEA)

Another one people like to go with is the Root Mean Squared Error Approximation (RMSEA). This statistic takes some math and background to understand, which I'm not going to go over here. I found [this document](http://www.statpower.net/Content/312/Handout/Measures%20of%20Fit%20in%20Structural%20Equation%20Modeling.pdf) to be the clearest (but also pretty mathy) explanation.

Essentially RMSEA is a weighted sum of the discrepancies between the model's reconstructed correlation matrix and the empirical correlation matrix. But it also does a nice thing where it discounts model complexity and sample size to help us not overfit. Here's the definition:

$\text{RMSEA} = \sqrt{\dfrac{Ï‡^2 - \text{df}}{\text{df}(n-1)}}$

See how it takes the chi-squared statistic and divides it by degrees of freedom (as a proxy for model complexity) and sample size? This makes for a more conservative measure of goodness-of-fit. Apparently the square-root is used *"to return the index to the same metric as the original standardized parameters"*. I don't really understand that part.

As with the raw chi-squared statistic, we want RMSEA to be small because it is intended as a measure of the distance between the empirical correlation matrix and the model-estimated correlation matrix. According to @Finch2015, people like to say:

-    RMSEA \<= 0.05 is a 'good fit';

-   0.05 \< RMSEA \<= 0.08 is an 'ok fit'

-   RMSEA > .08 is a 'bad fit'.

**Comparative Fit Index (CFI)**

## Example 2:

```{r message=FALSE, warning=FALSE}

dat_ff <- foreign::read.spss('data/finch-and-french/performance.data.sav')

# Seems like I need to only use the first 12 columns I think?
dat_ff <- dat_ff %>% 
  
  as_tibble() %>% 
  
  select(1:12)

```

Next we'll do another example from @Finch2015, from the SEM chapter on page 62. They say it is important to CFA first before testing the relationships between the latent variables a la SEM, because we first want to make sure those latent variables actually seem good. This example uses a different dataset than the previous one.

> \[W\]e must ascertain whether the proposed model structure is supported by our data, which we will do by fitting a CFA to each of the latent variables...

The authors fit a CFA for each of the latent variables in isolation, namely Mastery, Self-Oriented Perfectionism, and 'ATTC', [which seems to mean 'Attention Control'](https://arc.psych.wisc.edu/self-report/attention-control-scale-attc/#:~:text=The%20Attention%20Control%20Scale%20(ATTC,)%20to%204%20(always).)

```{r message=FALSE, warning=FALSE}

```

## Example 3:

Now we'll look at an example from @Kline2011, chapter 13.

Load the data:

```{r}

dat_kline <- read_csv('data/kline/kabc-amos.csv')


```

## Example 4:

Lastly, let's walk through [an example from the lavaan documentation](https://www.lavaan.ugent.be/tutorial/cfa.html)
